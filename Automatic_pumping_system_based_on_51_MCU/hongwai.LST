C51 COMPILER V9.54   HONGWAI                                                               01/01/2018 20:49:10 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE HONGWAI
OBJECT MODULE PLACED IN hongwai.OBJ
COMPILER INVOKED BY: D:\Program Files\Keil_v5\C51\BIN\C51.EXE hongwai.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS
                    -(2)

line level    source

   1          /**************************************************************************************
   2          *                 红外通信实验                          *
   3          实现现象：  具体接线操作请参考视频
   4                下载程序后，数码管显示红外遥控键值数据
   5          注意事项：  红外遥控模块的短接片J1短接，
   6                红外遥控器内的电池绝缘片一定要抽掉                                        
   7          ***************************************************************************************/
   8          
   9          #include "reg51.h"       //此文件中定义了单片机的一些特殊功能寄存器
  10          #include "hongwai.h"
  11          #include "lcd12864.h"
  12          
  13          typedef unsigned int u16;   //对数据类型进行声明定义
  14          typedef unsigned char u8;
  15          
  16          u8 IrValue[6];
  17          u8 Time;
  18          
  19          u8 DisplayData[8];
  20          u8 code smgduan[17]={
  21          0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,
  22          0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71,0X76};
  23          //0、1、2、3、4、5、6、7、8、9、A、b、C、d、E、F、H的显示码
  24          
  25          /*******************************************************************************
  26          * 函 数 名         : delay
  27          * 函数功能       : 延时函数，i=1时，大约延时10us
  28          *******************************************************************************/
  29          void delay(u16 i)
  30          {
  31   1        while(i--); 
  32   1      }
  33          
  34          
  35          /*******************************************************************************
  36          * 函数名         :DigDisplay()
  37          * 函数功能     :数码管显示函数
  38          * 输入           : 无
  39          * 输出           : 无
  40          *******************************************************************************/
  41          void DigDisplay()
  42          {
  43   1        u8 i;
  44   1        for(i=0;i<3;i++)
  45   1        {
  46   2          switch(i)  //位选，选择点亮的数码管，
  47   2          {
  48   3            case(0):
  49   3              LSA=0;LSB=0;LSC=0; break;//显示第0位
  50   3            case(1):
  51   3              LSA=1;LSB=0;LSC=0; break;//显示第1位
  52   3            case(2):
  53   3              LSA=0;LSB=1;LSC=0; break;//显示第2位  
  54   3          }
C51 COMPILER V9.54   HONGWAI                                                               01/01/2018 20:49:10 PAGE 2   

  55   2          P0=DisplayData[i];//发送数据
  56   2          delay(100); //间隔一段时间扫描  
  57   2          P0=0x00;//消隐
  58   2        }   
  59   1      }
  60          
  61          
  62          /*******************************************************************************
  63          * 函数名         : IrInit()
  64          * 函数功能       : 初始化红外线接收
  65          * 输入           : 无
  66          * 输出           : 无
  67          *******************************************************************************/
  68          
  69          void IrInit()
  70          {
  71   1        IT0=1;//下降沿触发
  72   1        EX0=1;//打开中断0允许
  73   1        EA=1; //打开总中断
  74   1      
  75   1        IRIN=1;//初始化端口
  76   1      }
  77          
  78          
  79          /*******************************************************************************
  80          * 函 数 名       : main
  81          * 函数功能     : 主函数
  82          * 输    入       : 无
  83          * 输    出       : 无
  84          *******************************************************************************/
  85          void HongWai()
  86          { 
  87   1        IrInit();
  88   1      
  89   1          LCD12864_SetWindow(2,0);
  90   1          LCD12864_WriteData(IrValue[2]/16);
  91   1          LCD12864_WriteData(IrValue[2]%16);
  92   1          DisplayData[2] = smgduan[16];
  93   1          DigDisplay();     
  94   1      }
  95          
  96          /*******************************************************************************
  97          * 函数名         : ReadIr()
  98          * 函数功能       : 读取红外数值的中断函数
  99          * 输入           : 无
 100          * 输出           : 无
 101          *******************************************************************************/
 102          
 103          void ReadIr() interrupt 0
 104          {
 105   1        u8 j,k;
 106   1        u16 err;
 107   1        Time=0;          
 108   1        delay(700); //7ms
 109   1        if(IRIN==0)   //确认是否真的接收到正确的信号
 110   1        {  
 111   2          
 112   2          err=1000;       //1000*10us=10ms,超过说明接收到错误的信号
 113   2          /*当两个条件都为真是循环，如果有一个条件为假的时候跳出循环，免得程序出错的时
 114   2          侯，程序死在这里*/  
 115   2          while((IRIN==0)&&(err>0)) //等待前面9ms的低电平过去     
 116   2          {     
C51 COMPILER V9.54   HONGWAI                                                               01/01/2018 20:49:10 PAGE 3   

 117   3            delay(1);
 118   3            err--;
 119   3          } 
 120   2          if(IRIN==1)     //如果正确等到9ms低电平
 121   2          {
 122   3            err=500;
 123   3            while((IRIN==1)&&(err>0))    //等待4.5ms的起始高电平过去
 124   3            {
 125   4              delay(1);
 126   4              err--;
 127   4            }
 128   3            for(k=0;k<4;k++)    //共有4组数据
 129   3            {       
 130   4              for(j=0;j<8;j++)  //接收一组数据
 131   4              {
 132   5      
 133   5                err=60;   
 134   5                while((IRIN==0)&&(err>0))//等待信号前面的560us低电平过去
 135   5                {
 136   6                  delay(1);
 137   6                  err--;
 138   6                }
 139   5                err=500;
 140   5                while((IRIN==1)&&(err>0))  //计算高电平的时间长度。
 141   5                {
 142   6                  delay(10);   //0.1ms
 143   6                  Time++;
 144   6                  err--;
 145   6                  if(Time>30)
 146   6                  {
 147   7                    return;
 148   7                  }
 149   6                }
 150   5                IrValue[k]>>=1;  //k表示第几组数据
 151   5                if(Time>=8)     //如果高电平出现大于565us，那么是1
 152   5                {
 153   6                  IrValue[k]|=0x80;
 154   6                }
 155   5                Time=0;   //用完时间要重新赋值              
 156   5              }
 157   4            }
 158   3          }
 159   2          if(IrValue[2]!=~IrValue[3])
 160   2          {
 161   3            return;
 162   3          }
 163   2        }     
 164   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    343    ----
   CONSTANT SIZE    =     17    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     15       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
